{"version":3,"sources":["SpreadsheetClient.js","App.js","index.js"],"names":["SpreadsheetClient","wsUri","Object","classCallCheck","this","onConnected","bind","onDisconnected","beforeRequest","afterResponse","onError","listener","wsClient","createWebSocketClient","registeredListeners","registeredChangeListeners","request","onOk","sendRequest","response","isReady","push","i","length","splice","actionName","changeListener","hasOwnProperty","changeListeners","console","log","forEach","l","txId","resp","changes","actions","act","k","listeners","Array","isArray","j","msg","websocket","timer","isOpen","_txId","msgCallbacks","WebSocket","onopen","evt","setInterval","ping","onOpen","onclose","clearInterval","onClose","onmessage","onMessage","onerror","send","EditResponse","deserialize","JSON","parse","data","key","msgCallback","action","callback","Error","req","stringify","App","props","_this","possibleConstructorReturn","getPrototypeOf","call","state","presentation","service","setEditMode","assertThisInitialized","setPresentationMode","openWorkbookAfterServiceReady","_this2","openWorkbook","setTimeout","_this3","Action","WorkbookOperation","statusCode","setState","workbook","react_default","a","createElement","className","href","onClick","renderContent","lib","Component","defaultProps","window","location","host","ReactDOM","render","react_router_dom","src_App_0","document","getElementById"],"mappings":"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","file":"static/js/main.e7af221e.chunk.js","sourcesContent":["import EditResponse from \"@littleorca/ferris-wheel/lib/action/EditResponse\";\nimport Values from '@littleorca/ferris-wheel/lib/model/Values';\n\nexport default class SpreadsheetClient {\n\n    /**\n     * Protobuf client via websocket.\n     * @param {string} wsUri \n     */\n    constructor(wsUri) {\n\n        this.onConnected = this.onConnected.bind(this);\n        this.onDisconnected = this.onDisconnected.bind(this);\n        this.beforeRequest = this.beforeRequest.bind(this);\n        this.afterResponse = this.afterResponse.bind(this);\n        this.onError = this.onError.bind(this);\n\n        this.listener = {\n            onConnected: this.onConnected,\n            onDisconnected: this.onDisconnected,\n            beforeRequest: this.beforeRequest,\n            afterResponse: this.afterResponse,\n            onError: this.onError,\n        };\n\n        this.wsClient = this.createWebSocketClient(wsUri, this.listener);\n        this.registeredListeners = [];\n        this.registeredChangeListeners = {};\n    }\n\n    /**\n     * Implements Service interface.\n     *\n     * type OkCallback = (resp: EditResponse) => void;\n     * type ErrorCallback = () => void;\n     *\n     * interface Service {\n     * call: (\n     *    request: EditRequest,\n     *    onOk: OkCallback,\n     *    onError: ErrorCallback\n     * ) => void;\n     * }\n     */\n    call(request, onOk, onError) {\n        this.wsClient.sendRequest(request, (response) => {\n            onOk(response);\n        });\n    }\n\n    isBusy() {\n        return !this.isReady;\n    }\n\n    isReady() {\n        return this.wsClient.isReady();\n    }\n\n    /**\n     * Listener\n     */\n\n    addListener(listener) {\n        this.registeredListeners.push(listener);\n    }\n\n    removeListener(listener) {\n        for (let i = 0; i < this.registeredListeners.length; i++) {\n            if (this.registeredListeners[i] === listener) {\n                this.registeredListeners.splice(i, 1);\n                break;\n            }\n        }\n    }\n\n    clearListeners() {\n        this.registeredListeners = [];\n    }\n\n    addChangeListener(actionName, changeListener) {\n        if (!this.registeredChangeListeners.hasOwnProperty(actionName)) {\n            this.registeredChangeListeners[actionName] = [];\n        }\n        this.registeredChangeListeners[actionName].push(changeListener);\n    }\n\n    removeChangeListener(actionName, changeListener) {\n        if (!this.registeredChangeListeners.hasOwnProperty(actionName)) {\n            return;\n        }\n        const changeListeners = this.registeredChangeListeners[actionName];\n        for (let i = 0; i < changeListeners.length; i++) {\n            if (changeListeners[i] === changeListener) {\n                changeListeners.splice(i, 1);\n                break;\n            }\n        }\n    }\n\n    clearChangeListeners() {\n        this.registeredChangeListeners = {};\n    }\n\n    onConnected() {\n        console.log('listener: onConnected');\n        this.registeredListeners.forEach(l => l.onConnected());\n    }\n\n    onDisconnected() {\n        console.log('listener: onDisconnected');\n        this.registeredListeners.forEach(l => l.onDisconnected());\n    }\n\n    beforeRequest(txId) {\n        // console.log('listener: beforeRequest', txId);\n        this.registeredListeners.forEach(l => l.beforeRequest(txId));\n    }\n\n    afterResponse(resp) {\n        // console.log('listener: afterResponse', resp);\n        this.registeredListeners.forEach(l => l.afterResponse(resp));\n        // distribute changes if any\n        if (resp.changes) {\n            for (let i = 0; i < resp.changes.actions.length; i++) {\n                const act = resp.changes.actions[i];\n                for (let k in act) {\n                    if (!act.hasOwnProperty(k)) {\n                        continue;\n                    }\n                    const listeners = this.registeredChangeListeners[k];\n                    if (typeof listeners !== 'undefined' && Array.isArray(listeners)) {\n                        for (let j = 0; j < listeners.length; j++) {\n                            console.log(\"notify\", act[k]);\n                            listeners[j](act[k]);\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    onError(msg) {\n        console.log('listener: onError', msg);\n        this.registeredListeners.forEach(l => { l.onError(msg) });\n    }\n\n    /**\n     * Spreadsheet protobuf client.\n     * @param {string} wsUri \n     */\n    createWebSocketClient(wsUri, listener) {\n\n        var _wsUri = wsUri;\n\n        var websocket;\n        var isOpen = false;\n\n        var _txId = 1;\n        var msgCallbacks = {};\n\n        var timer;\n\n        websocket = new WebSocket(_wsUri);\n\n        websocket.onopen = function (evt) {\n            isOpen = true;\n            timer = setInterval(ping, 15000);\n            onOpen(evt);\n        };\n\n        websocket.onclose = function (evt) {\n            isOpen = false;\n            clearInterval(timer);\n            onClose(evt);\n        };\n\n        websocket.onmessage = function (evt) {\n            onMessage(evt)\n        };\n\n        websocket.onerror = function (evt) {\n            onError(evt)\n        };\n\n        var ping = function () {\n            if (isReady()) {\n                msgCallbacks['txid-0'] = function () { };\n                websocket.send('{txId:0}');\n            }\n        }\n\n        var onOpen = function (evt) {\n            console.log(\"Connected.\");\n            if (typeof listener !== 'undefined'\n                && typeof listener.onConnected === 'function') {\n                listener.onConnected();\n            }\n        };\n\n        var onClose = function (evt) {\n            console.log(\"Connection closed.\");\n            if (typeof listener !== 'undefined'\n                && typeof listener.onDisconnected === 'function') {\n                listener.onDisconnected();\n            }\n        };\n\n        var onMessage = function (evt) {\n            var msg = EditResponse.deserialize(JSON.parse(evt.data));\n            console.log('onMessage', msg);\n            var key = 'txid-' + msg.txId;\n            var msgCallback = msgCallbacks[key];\n            if (typeof msgCallback === 'function') {\n                msgCallback(msg);\n                delete msgCallbacks[key];\n            } else {\n                console.log('WARN: msgCallback not defined!');\n            }\n\n            if (typeof listener !== 'undefined'\n                && typeof listener.afterResponse === 'function') {\n                listener.afterResponse(msg);\n            }\n        };\n\n        var onError = function (evt) {\n            console.log(\"WebSocket error occurred.\");\n            msgCallbacks = {}; // reset callback functions\n            // FIXME there could be some problems.\n            if (typeof listener !== 'undefined'\n                && typeof listener.onError === 'function') {\n                listener.onError('WebSocket error!');\n            }\n        };\n\n        var isReady = function () {\n            return websocket && isOpen;\n        };\n\n        var send = function (action, callback) {\n            if (!isReady()) {\n                throw new Error(\"WebSocket not ready.\");\n            }\n            var txId = _txId++;\n            var req = {\n                txId: txId,\n                action: action\n            }\n\n            if (typeof callback === 'function') {\n                msgCallbacks['txid-' + txId] = callback;\n            }\n\n            if (typeof listener !== 'undefined'\n                && typeof listener.beforeRequest === 'function') {\n                listener.beforeRequest(txId);\n            }\n\n            websocket.send(JSON.stringify(req));\n        };\n\n        var sendRequest = function (request, callback) {\n            if (!isReady()) {\n                throw new Error(\"WebSocket not ready.\");\n            }\n            if (typeof callback === 'function') {\n                msgCallbacks['txid-' + request.txId] = callback;\n            }\n            if (typeof listener !== 'undefined'\n                && typeof listener.beforeRequest === 'function') {\n                listener.beforeRequest(request.txId);\n            }\n            websocket.send(JSON.stringify(request));\n        }\n\n        return {\n            isReady: isReady,\n            send: send,\n            sendRequest: sendRequest,\n        };\n\n    }\n}\n","import React, { Component } from 'react';\nimport SpreadsheetClient from './SpreadsheetClient';\nimport {\n  Workbook, WorkbookEditor, WorkbookPresenter\n} from '@littleorca/ferris-wheel';\nimport Action from \"@littleorca/ferris-wheel/lib/action/Action\";\nimport WorkbookOperation from \"@littleorca/ferris-wheel/lib/action/WorkbookOperation\";\nimport '@littleorca/ferris-wheel/theme/default/theme.css';\nimport './App.css';\n\nclass App extends Component {\n\n  static defaultProps = {\n    wsUri: 'ws://' + window.location.host + '/wsapi'\n  };\n\n  constructor(props) {\n    super(props);\n\n    this.state = {\n      presentation: false,\n    };\n\n\n    this.service = new SpreadsheetClient(this.props.wsUri);\n    this.setEditMode = this.setEditMode.bind(this);\n    this.setPresentationMode = this.setPresentationMode.bind(this);\n  }\n\n  componentDidMount() {\n    this.openWorkbookAfterServiceReady();\n  }\n\n  openWorkbookAfterServiceReady() {\n    if (this.service.isReady()) {\n      this.openWorkbook();\n    } else {\n      setTimeout(() => this.openWorkbookAfterServiceReady(), 100);\n    }\n  }\n\n  openWorkbook() {\n    const action = new Action();\n    action.openWorkbook = new WorkbookOperation();\n    this.service.call({\n      txId: 0,\n      action: action,\n    }, resp => {\n      console.log('open workbook', resp);\n      if (resp.statusCode === 0) {\n        this.setState({\n          workbook: resp.workbook,\n        });\n      }\n    });\n  }\n\n  setEditMode() {\n    this.setState({ presentation: false });\n  }\n\n  setPresentationMode() {\n    this.setState({ presentation: true });\n  }\n\n  render() {\n    return (\n      <div className=\"wrapper\">\n\n        <div className=\"header\">\n          <ul>\n            <li className={this.state.presentation ? \"\" : \"selected\"}>\n              <a href=\"javascript:void(0);\" onClick={this.setEditMode}>编辑模式</a>\n            </li>\n            <li className={this.state.presentation ? \"selected\" : \"\"}>\n              <a href=\"javascript:void(0);\" onClick={this.setPresentationMode}>展示模式</a>\n            </li>\n          </ul>\n        </div>\n\n        <div className=\"content\">\n          {this.renderContent()}\n        </div>\n      </div>\n    );\n  }\n\n  renderContent() {\n    const workbook = this.state.workbook;\n    if (typeof workbook !== 'undefined') {\n      return (\n        this.state.presentation ?\n          (\n            <WorkbookPresenter\n              workbook={workbook}\n              service={this.service} />\n          ) : (\n            <WorkbookEditor\n              workbook={workbook}\n              service={this.service} />\n          )\n      );\n\n    } else {\n      return <div className=\"loading\">Loading...</div>;\n    }\n  }\n\n}\n\nexport default App;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport { BrowserRouter } from 'react-router-dom';\nimport './index.css';\nimport App from './App';\n// import registerServiceWorker from './registerServiceWorker';\n\nReactDOM.render(\n    <BrowserRouter>\n        <App />\n    </BrowserRouter>,\n    document.getElementById('root'));\n// registerServiceWorker();\n"],"sourceRoot":""}